@page "/chat"
@using Microsoft.SemanticKernel
@using Microsoft.SemanticKernel.ChatCompletion
@attribute [Authorize]
@inject ITenantConfig tenantConfig

<PageTitle>Chat</PageTitle>

<TheChat AfterRender="OnAfterRender" @ref="ctrl"></TheChat>

@code {
    TheChat ctrl;

    [Inject(Key ="MyKernel")]
    public Kernel MyKernel { get; set; }

    IChatCompletionService chatCompletionService;

    ChatHistory history;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Get chat completion service
            chatCompletionService = MyKernel.GetRequiredService<IChatCompletionService>();

            // Enable auto function calling
            PromptExecutionSettings promptExecutionSettings = new()
            {
                FunctionChoiceBehavior = FunctionChoiceBehavior.Auto()
            };

            history = new ChatHistory();
            history.AddSystemMessage("Sei un assistente esperto in automazione IoT e domotica. Rispondi sempre in modo professionale e tecnico. Rispondi sempre con snippet HTML. Il tuo obiettivo è rispondere a domande su cosa puoi fare con il modello dati per eseguire query DAX. ");

            ctrl.Handle(async input =>
            {
                history.AddMessage(AuthorRole.User, input);
                var i = 1;
                while (i<=3) 
                {
                    try
                    {
                        ChatMessageContent chatResult = await chatCompletionService.GetChatMessageContentAsync(history, promptExecutionSettings, MyKernel, CancellationToken.None);


                        history.Add(chatResult);

                        await ctrl.AddMessageAsync($"{chatResult}", "AI");

                        break;
                    }
                    catch (Exception ex)
                    {
                        var msg = $"ERRORE nell'esecuzione {i}: {ex.Message}. Tienine conto per il nuovo tentativo";
                        history.Add(new ChatMessageContent(AuthorRole.Assistant, msg));
                        await ctrl.AddMessageAsync(msg, "AI");
                    }
                    i++;
                }
                if (i > 3)
                {
                    await ctrl.AddMessageAsync($"ERRORE: non sono riuscito a rispondere", "AI");
                }
            });

            // string? input = null;
            // while ((input = Console.ReadLine()) is not null)
            // {
            //     try
            //     {
            //         Console.WriteLine();


            //         history.Add(chatResult);

            //         Console.Write($"\n>>> Result2: {chatResult}\n\n> ");
            //     }
            //     catch (Exception ex)
            //     {
            //         Console.WriteLine($"\n>>> Exception: {ex.Message}\n\n> ");
            //     }
            // }

            StateHasChanged();
        }
    }

    private async Task OnAfterRender()
    {
    }
}