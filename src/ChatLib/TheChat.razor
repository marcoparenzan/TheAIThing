@using Microsoft.JSInterop
@using MudBlazor
@inject ChatJsInterop interop

<!-- Add inline flex + fixed sidebar width so it stays on the side even if CSS isn't loaded -->
<div @ref="el" class="chat-root" style="display:flex;width:100%;height:100%;min-height:0;">
    <!-- Main Chat Area -->
    <MudPaper Elevation="0" Class="chat-main" style="position:relative;flex:1 1 auto;min-width:0;min-height:0;--chat-input-height:72px;">
        <!-- Messages viewport (scrolls); input overlays -->
        <div class="chat-messages" style="position:absolute;inset:0;overflow-y:auto;padding:16px;padding-bottom:calc(16px + var(--chat-input-height));">
            <div id="chatContainer"></div>
        </div>

        <!-- Input docked at bottom; overlays messages and never scrolls away -->
        <div class="chat-input" style="position:absolute;left:0;right:0;bottom:0;height:var(--chat-input-height);background-color:var(--mud-palette-surface);border-top:1px solid var(--mud-palette-lines-default);box-shadow:0 -2px 6px rgba(0,0,0,0.06);z-index:2;">
            <div class="chat-input-inner" style="display:flex;align-items:center;gap:8px;height:100%;padding:12px 16px;">
                <MudTextField T="string"
                              Id="messageInput"
                              Placeholder="Type your message..."
                              Variant="Variant.Outlined"
                              FullWidth="true" />
                <MudButton Id="sendButton"
                           Variant="Variant.Filled"
                           Color="Color.Primary">
                    Send
                </MudButton>
            </div>
        </div>
    </MudPaper>

    <!-- Right Sidebar (fixed width, never wraps under) -->
    <MudPaper Elevation="0" Class="chat-sidebar" style="flex:0 0 320px;width:320px;background-color:var(--mud-palette-surface);border-left:1px solid var(--mud-palette-lines-default);display:flex;flex-direction:column;min-height:0;">
        <MudPaper Elevation="0" Class="chat-sidebar-header" style="padding:16px;border-bottom:1px solid var(--mud-palette-lines-default);">
            <MudText Typo="Typo.h6">Actions</MudText>
        </MudPaper>
        <div id="actionsList" class="chat-actions" style="flex:1 1 auto;overflow-y:auto;padding:16px;min-height:0;"></div>
    </MudPaper>
</div>

@code {
    [Parameter] public EventCallback AfterRender { get; set; }

    private ElementReference el;
    private DotNetObjectReference<TheChat>? proxy;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            proxy = DotNetObjectReference.Create(this);
            await interop.SetupAsync("abc", proxy, el, "");
            await AfterRender.InvokeAsync();
        }
    }

    public async Task ShowReportAsync(string accessToken, string embedUrl, string embedReportId)
        => await interop.ShowReportAsync("abc", accessToken, embedUrl, embedReportId);
}